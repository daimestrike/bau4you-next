# Настройка базы данных Supabase для Bau4You

## Описание таблиц

Система включает следующие основные таблицы:

### 1. **profiles** - Профили пользователей
- Расширение таблицы `auth.users` с дополнительными полями
- Роли: `client`, `contractor`, `supplier`, `admin`
- Автоматически создается при регистрации пользователя

### 2. **companies** - Компании
- Информация о компаниях (подрядчики, поставщики)
- Связана с владельцем (owner_id)
- Типы: `contractor`, `supplier`, `both`

### 3. **projects** - Проекты
- Основная сущность для управления строительными проектами
- Включает материалы и требования к компаниям в JSON
- Статусы: `planning`, `active`, `completed`, `on_hold`

### 4. **project_materials** - Материалы проекта
- Связь многие-ко-многим между проектами и продуктами
- Отслеживание количества и статуса материалов
- Статусы: `planned`, `ordered`, `delivered`, `installed`

### 5. **project_companies** - Компании проекта
- Связь многие-ко-многим между проектами и компаниями
- Роли и бюджеты для каждой компании в проекте
- Статусы: `searching`, `negotiating`, `contracted`, `working`, `completed`

### 6. **tenders** - Тендеры
- Публичные заказы для подрядчиков
- Статусы: `draft`, `published`, `in_progress`, `completed`, `cancelled`

### 7. **applications** - Заявки на тендеры
- Заявки подрядчиков на участие в тендерах
- Статусы: `pending`, `accepted`, `rejected`, `withdrawn`

### 8. **products** - Товары/Материалы
- Каталог строительных материалов и товаров
- Поддержка изображений и технических характеристик в JSON
- Статусы: `active`, `inactive`, `out_of_stock`

### 9. **messages** - Сообщения
- Система обмена сообщениями между пользователями
- Может быть привязана к тендерам или проектам

### 10. **notifications** - Уведомления
- Системные уведомления для пользователей

### 11. **orders** и **order_items** - Заказы
- Система заказов материалов
- Связь с проектами

## Инструкция по установке

### Шаг 1: Создание проекта в Supabase
1. Зайдите на [supabase.com](https://supabase.com)
2. Создайте новый проект
3. Дождитесь завершения инициализации

### Шаг 2: Выполнение SQL скрипта
1. Откройте SQL Editor в панели Supabase
2. Скопируйте весь код из файла `supabase_schema.sql`
3. Вставьте в SQL Editor и выполните

### Шаг 3: Проверка создания таблиц
В Table Editor должны появиться все таблицы:
- profiles
- companies
- projects
- project_materials
- project_companies
- tenders
- applications
- products
- messages
- notifications
- profile_experience
- profile_services
- orders
- order_items

### Шаг 4: Отключение подтверждения email (для разработки)
Для упрощения разработки рекомендуется временно отключить подтверждение email:

1. В панели Supabase перейдите в **Authentication** → **Settings**
2. В разделе **Email Auth** найдите **"Confirm email"**
3. Отключите опцию **"Enable email confirmations"**
4. Сохраните изменения

**Важно**: В продакшене обязательно включите подтверждение email для безопасности!

### Шаг 5: Настройка переменных окружения
Убедитесь, что в файле `.env.local` указаны правильные ключи:

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### Шаг 6: Проверка работы
1. Запустите приложение: `npm run dev`
2. Зарегистрируйтесь как новый пользователь
3. Проверьте, что профиль создался автоматически в таблице `profiles`
4. После регистрации вы должны автоматически попасть на дашборд

## Особенности безопасности

### Row Level Security (RLS)
Все таблицы защищены политиками RLS:
- Пользователи видят только свои данные
- Публичная информация (компании, активные продукты) доступна всем авторизованным пользователям
- Автоматическое присвоение владельца при создании записей

### Автоматические триггеры
- **Создание профиля**: При регистрации автоматически создается запись в `profiles`
- **Обновление timestamp**: Автоматическое обновление `updated_at` при изменении записей

### Индексы производительности
Созданы индексы для часто используемых запросов:
- По ролям пользователей
- По статусам проектов и тендеров
- По категориям продуктов
- По связанным записям (foreign keys)

## Логика связей

### Проекты → Материалы → Продукты
```
projects → project_materials → products
```
- Проект может содержать множество материалов
- Материал может быть связан с конкретным продуктом из каталога
- Отслеживание количества и статуса каждого материала

### Проекты → Компании
```
projects → project_companies → companies
```
- Проект может включать множество компаний с разными ролями
- Отслеживание бюджета и статуса работы каждой компании

### Тендеры → Заявки
```
tenders → applications (contractor_id)
```
- На каждый тендер могут подавать заявки множество подрядчиков
- Один подрядчик может подать только одну заявку на тендер

## Тестовые данные (опционально)

После создания схемы можно добавить тестовые данные для проверки:

```sql
-- Создание тестовой компании
INSERT INTO companies (name, description, type, location, owner_id)
VALUES ('ООО "СтройКомпани"', 'Генеральный подрядчик', 'contractor', 'Москва', auth.uid());

-- Создание тестового продукта
INSERT INTO products (name, description, category, price, seller_id)
VALUES ('Кирпич керамический', 'Кирпич красный полнотелый', 'Стройматериалы', 15.50, auth.uid());
```

## Поддержка и расширение

Схема легко расширяется для добавления новых функций:
- Система рейтингов и отзывов
- Геолокация для проектов и компаний
- Файловое хранилище для документов
- Интеграция с платежными системами
- Чат в реальном времени через Supabase Realtime 