# Миграция базы данных - Добавление поля region_id в компании

## Описание изменений

В рамках улучшения функциональности редактирования компаний добавлено поле `region_id` в таблицу `companies` для связи с таблицей `regions`.

## SQL миграция

Выполните следующую SQL команду в Supabase Dashboard или через CLI:

```sql
-- Добавляем поле region_id в таблицу companies
ALTER TABLE companies ADD COLUMN IF NOT EXISTS region_id UUID REFERENCES regions(id);

-- Создаем индекс для оптимизации запросов
CREATE INDEX IF NOT EXISTS idx_companies_region_id ON companies(region_id);
```

## Что изменилось в коде

### 1. Интерфейс CompanyData
- Убрано поле `location: string`
- Добавлено поле `region_id?: string`

### 2. Страница редактирования компаний (`src/app/companies/edit/page.tsx`)
- Текстовое поле "Местоположение" заменено на выпадающее меню "Регион"
- Добавлена загрузка списка регионов из базы данных
- Обновлена логика сохранения данных

### 3. Функция getCompany (`src/lib/supabase.ts`)
- Добавлен JOIN с таблицей regions для загрузки названия региона

### 4. Страницы отображения компаний
- Обновлены интерфейсы для использования `region_id` вместо `location`
- Исправлено отображение региона на странице компании

## Проверка миграции

После выполнения миграции проверьте:

1. **Структура таблицы**:
   ```sql
   SELECT column_name, data_type, is_nullable 
   FROM information_schema.columns 
   WHERE table_name = 'companies' AND column_name = 'region_id';
   ```

2. **Создание/редактирование компании**:
   - Откройте `/companies/edit`
   - Выберите регион из выпадающего списка
   - Сохраните изменения
   - Убедитесь, что данные сохранились

3. **Отображение компаний**:
   - Проверьте страницу списка компаний `/companies`
   - Проверьте страницу отдельной компании `/companies/[id]`
   - Убедитесь, что регион отображается корректно

## Откат изменений (если необходимо)

Если потребуется откатить изменения:

```sql
-- Удаляем поле region_id
ALTER TABLE companies DROP COLUMN IF EXISTS region_id;

-- Удаляем индекс
DROP INDEX IF EXISTS idx_companies_region_id;
```

**Внимание:** При откате будут потеряны все данные о регионах компаний.

## Дополнительные рекомендации

1. **Миграция существующих данных**: Если у вас есть компании с заполненным полем `location`, рассмотрите возможность написания скрипта для сопоставления текстовых локаций с регионами из таблицы `regions`.

2. **Тестирование**: Обязательно протестируйте функциональность на staging окружении перед применением в production.

3. **Backup**: Создайте резервную копию базы данных перед выполнением миграции. 